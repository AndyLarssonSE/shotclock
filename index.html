<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Andy Larsson - Nineball Timer</title>
<style>
  :root{
    --bg1:#6d7b62; --bg2:#566654;
    --btn:#f2f2f2; --btnText:#111; --btnShadow:#0007;
    --accent:#6f3ad3; --danger:#b83a3a; --mid:#cfd4dd; --gold:#d4af37;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#fff;-webkit-user-select:none;user-select:none}
  .container{max-width:900px;margin:0 auto;padding:10px 14px 28px}
  .grid{
    display:grid; grid-template-columns:1fr 1fr 1fr; grid-template-rows:auto auto auto auto auto auto auto auto;
    gap:18px; align-items:center; justify-items:center;
  }

  .race-wrap{grid-column:1/4; text-align:center; margin-top:6px}
  .race-title{font-weight:700; letter-spacing:.5px; text-shadow:0 2px 0 #0005; font-size:28px}
  .race-value{margin-top:4px; font-weight:800; font-size:24px; text-shadow:0 2px 0 #0005}

  .btn{appearance:none;border:none;border-radius:14px;background:var(--btn); color:var(--btnText);
       padding:16px 18px; font-weight:800; letter-spacing:.4px; box-shadow:0 6px 14px var(--btnShadow);
       transition:transform .05s ease, filter .15s ease; font-size:18px}
  .btn:active{transform:translateY(1px) scale(.99)}
  .btn.small{padding:12px 14px; font-size:16px}
  .btn.wide{min-width:150px}
  .btn.block{width:100%}
  .btn.white{background:#fff; color:#111}
  .btn.gray{background:var(--mid)}
  .btn.red{background:linear-gradient(#d85a5a,#b63e3e); color:#fff}
  .btn.purple{background:var(--btn); color:#000}
  .btn.purple.active{background:linear-gradient(#8d60e9,#6f3ad3); color:#fff}

  .name{font-size:40px; font-weight:800; text-shadow:0 4px 0 #0005}
  .score{font-size:48px; font-weight:900; text-shadow:0 4px 0 #0005; margin-top:-8px}
  .name.win{color:var(--gold)}
  .name.lose{color:#000}

  .clock{grid-column:2/3; grid-row:3/4; font-size:160px; line-height:1; font-weight:900; text-shadow:0 10px 0 #0005}
  .clock.red{color:#ffefef; text-shadow:0 0 20px #ff000055, 0 10px 0 #0005}

  .left{grid-column:1/2} .middle{grid-column:2/3} .right{grid-column:3/4}
  .row1{grid-row:2/3} .row2{grid-row:3/4} .row3{grid-row:4/5}
  .row4{grid-row:5/6} .row5{grid-row:6/7} .row6{grid-row:7/8}
  .row7{grid-row:8/9} .row8{grid-row:9/10}

  .credit{grid-column:2/3; grid-row:3/4; align-self:end; margin-top:165px; font-weight:700; opacity:.25; font-size:18px}

  .big{padding:18px 22px; font-size:22px; min-width:180px}
  .huge{padding:20px 26px; font-size:26px; min-width:210px}

  #confetti{position:fixed; inset:0; pointer-events:none}

  /* Toast */
  #toast{
    position:fixed; left:50%; top:18%; transform:translateX(-50%);
    background:rgba(0,0,0,.75); color:#fff; padding:12px 16px; border-radius:12px;
    font-weight:800; letter-spacing:.3px; opacity:0; pointer-events:none; transition:opacity .15s ease;
    z-index:10;
  }
  #toast.show{opacity:1}
</style>
</head>
<body>
<canvas id="confetti"></canvas>
<div id="toast" role="status" aria-live="polite"></div>

<div class="container">
  <div class="grid" role="application" aria-label="Race Timer App">

    <div class="race-wrap">
      <div class="race-title">Race to</div>
      <div class="race-value"><span id="raceTo">8</span></div>
    </div>

    <div class="left  row1 name" id="p1Name">Player1</div>
    <div class="right row1 name" id="p2Name">Player2</div>

    <div class="left  row2 score" id="p1Score">0</div>
    <div class="clock" id="clock">30</div>
    <div class="right row2 score" id="p2Score">0</div>

    <button class="left  row3 btn purple wide big" id="p1Playing">PLAYING</button>
    <div class="credit">AndyLarsson.se</div>
    <button class="right row3 btn purple wide big" id="p2Playing">PLAYING</button>

    <!-- PAUSE above START -->
    <div class="middle row4"><button class="btn white wide big" id="pauseBtn">PAUSE</button></div>

    <button class="left  row5 btn huge wide" id="p1Plus">+1<br/>POINT</button>
    <button class="middle row5 btn white wide big" id="startBtn">START</button>
    <button class="right row5 btn huge wide" id="p2Plus">+1<br/>POINT</button>

    <button class="left  row6 btn red wide big" id="p1Ext">EXTENSION<br/>CALLED</button>
    <button class="middle row6 btn white wide big" id="resetClock">RESET<br/>CLOCK</button>
    <button class="right row6 btn red wide big" id="p2Ext">EXTENSION<br/>CALLED</button>

    <button class="left  row7 btn block small" id="editP1">Edit<br/>Player 1</button>
    <button class="middle row7 btn block small" id="editRace">Edit<br/>Race</button>
    <button class="right row7 btn block small" id="editP2">Edit<br/>Player 2</button>

    <div class="middle row8">
      <button class="btn block big white" id="resetScore">RESET<br/>SCORE</button>
    </div>
  </div>
</div>

<script>
(() => {
  /* ---------- State ---------- */
  let p1 = { name:'Player1', score:0 };
  let p2 = { name:'Player2', score:0 };
  let raceTo = 8;
  let timeLeft = 30;
  let ticking = false;
  let tickInterval = null;
  let startDelayTimer = null;
  let extensionLocked = false;
  let gameOver = false;

  /* ---------- DOM ---------- */
  const $ = sel => document.querySelector(sel);
  const els = {
    toast: $('#toast'),
    raceTo: $('#raceTo'),
    p1Name: $('#p1Name'), p2Name: $('#p2Name'),
    p1Score: $('#p1Score'), p2Score: $('#p2Score'),
    clock: $('#clock'),
    p1Playing: $('#p1Playing'), p2Playing: $('#p2Playing'),
    p1Plus: $('#p1Plus'), p2Plus: $('#p2Plus'),
    p1Ext: $('#p1Ext'), p2Ext: $('#p2Ext'),
    start: $('#startBtn'), resetClock: $('#resetClock'),
    pause: $('#pauseBtn'),
    editP1: $('#editP1'), editP2: $('#editP2'), editRace: $('#editRace'),
    resetScore: $('#resetScore'),
    confetti: $('#confetti')
  };

  /* ---------- Toast ---------- */
  let toastTimer=null;
  function showToast(msg, ms=1500){
    els.toast.textContent = msg;
    els.toast.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>els.toast.classList.remove('show'), ms);
  }

  /* ---------- Audio ---------- */
  let audioCtx = null;
  function ensureAudio(){ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended') audioCtx.resume(); }
  function tone(freq=880, dur=0.11, type='sine', gain=0.06){
    if(!audioCtx) return;
    const t0=audioCtx.currentTime, osc=audioCtx.createOscillator(), g=audioCtx.createGain();
    osc.type=type; osc.frequency.setValueAtTime(freq,t0);
    g.gain.setValueAtTime(0,t0); g.gain.linearRampToValueAtTime(gain,t0+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t0+dur);
    osc.connect(g).connect(audioCtx.destination); osc.start(t0); osc.stop(t0+dur+0.02);
  }
  const softBeep=()=>tone(880,0.12,'sine',0.05);
  const buzzer=()=>{tone(220,0.25,'square',0.07); setTimeout(()=>tone(140,0.25,'square',0.07),110);};

  /* ---------- Confetti ---------- */
  const cx = els.confetti.getContext('2d');
  let confettiPieces=[];
  function resizeCanvas(){ els.confetti.width=window.innerWidth; els.confetti.height=window.innerHeight; }
  window.addEventListener('resize', resizeCanvas, {passive:true}); resizeCanvas();
  function fireConfetti(){
    confettiPieces=[]; const colors=['#ffd166','#ef476f','#06d6a0','#118ab2','#8338ec','#ff9f1c','#f7fff7'];
    for(let i=0;i<180;i++){ confettiPieces.push({x:Math.random()*els.confetti.width,y:-20-Math.random()*80,r:2+Math.random()*5,c:colors[(Math.random()*colors.length)|0],vx:-2+Math.random()*4,vy:2+Math.random()*4+(Math.random()*2),life:120+Math.random()*40,rot:Math.random()*Math.PI});}
    animateConfetti(); setTimeout(()=>{confettiPieces=[]; cx.clearRect(0,0,els.confetti.width,els.confetti.height);},3000);
  }
  function animateConfetti(){
    if(!confettiPieces.length) return;
    cx.clearRect(0,0,els.confetti.width,els.confetti.height);
    for(const p of confettiPieces){ cx.save(); cx.translate(p.x,p.y); cx.rotate(p.rot+=0.08); cx.fillStyle=p.c; cx.fillRect(-p.r,-p.r,p.r*2,p.r*2); cx.restore(); p.x+=p.vx; p.y+=p.vy; p.vy+=0.03; p.life--; }
    confettiPieces=confettiPieces.filter(p=>p.life>0 && p.y<els.confetti.height+40);
    requestAnimationFrame(animateConfetti);
  }

  /* ---------- Helpers ---------- */
  function activeSide(){
    if(els.p1Playing.classList.contains('active')) return 'p1';
    if(els.p2Playing.classList.contains('active')) return 'p2';
    return null;
  }
  function updateUI(){
    els.p1Name.textContent=p1.name; els.p2Name.textContent=p2.name;
    els.p1Score.textContent=p1.score; els.p2Score.textContent=p2.score;
    els.clock.textContent=timeLeft.toString();
    if(timeLeft<=10) els.clock.classList.add('red'); else els.clock.classList.remove('red');
    els.raceTo.textContent=raceTo;

    // Start button: allow clicking even if no playing selected (so we can show the toast), but block when ticking/over/zero
    els.start.disabled = gameOver || ticking || timeLeft<=0;

    // Extension buttons: only the active side can use it (and only if not locked)
    const side = activeSide();
    els.p1Ext.disabled = gameOver || extensionLocked || timeLeft<=0 || side!=='p1';
    els.p2Ext.disabled = gameOver || extensionLocked || timeLeft<=0 || side!=='p2';
  }
  function stopTick(){
    ticking=false; clearInterval(tickInterval); tickInterval=null; clearTimeout(startDelayTimer); startDelayTimer=null; updateUI();
  }
  function startAfterDelay(delayMs=1000){
    ticking=true; updateUI();
    showToast('Starting clock', 1000);
    startDelayTimer=setTimeout(()=>{
      if(gameOver){ stopTick(); return; }
      tickInterval=setInterval(()=>{
        if(timeLeft>0){
          timeLeft--;
          if(timeLeft<=10 && timeLeft>0) softBeep();
          if(timeLeft===0){ buzzer(); stopTick(); }
          updateUI();
        } else { stopTick(); }
      },1000);
    }, delayMs);
  }
  function resetColors(){ els.p1Name.classList.remove('win','lose'); els.p2Name.classList.remove('win','lose'); }
  function declareWinner(w){ gameOver=true; if(w==='p1'){els.p1Name.classList.add('win'); els.p2Name.classList.add('lose');} else {els.p2Name.classList.add('win'); els.p1Name.classList.add('lose');} fireConfetti(); stopTick(); }
  function checkWinner(){ if(p1.score>=raceTo) declareWinner('p1'); else if(p2.score>=raceTo) declareWinner('p2'); }
  function score(forWho){
    if(gameOver) return;
    if(forWho==='p1') p1.score++; else p2.score++;
    extensionLocked=false;
    stopTick(); // pause after score
    updateUI(); checkWinner();
  }
  function setRace(){
    const v=prompt('Set "Race to" (number of frames to win):', raceTo);
    if(v===null) return;
    const n=parseInt(v,10);
    if(!Number.isFinite(n)||n<1||n>999){ alert('Enter a whole number from 1 to 999.'); return; }
    raceTo=n; updateUI(); checkWinner();
  }
  function setName(which){
    const current=which==='p1'?p1.name:p2.name;
    const v=prompt(`Enter ${which==='p1'?'Player 1':'Player 2'} name:`, current ?? '');
    if(v===null) return;
    const s=v.trim().slice(0,20); if(!s) return;
    if(which==='p1') p1.name=s; else p2.name=s; updateUI();
  }

  /* ---------- Wiring ---------- */
  document.addEventListener('touchstart', ensureAudio, {once:true});
  document.addEventListener('mousedown', ensureAudio, {once:true});

  els.p1Playing.addEventListener('click', ()=>{ els.p1Playing.classList.add('active'); els.p2Playing.classList.remove('active'); updateUI(); });
  els.p2Playing.addEventListener('click', ()=>{ els.p2Playing.classList.add('active'); els.p1Playing.classList.remove('active'); updateUI(); });

  els.start.addEventListener('click', ()=>{
    if(ticking || timeLeft<=0 || gameOver) return;
    const side = activeSide();
    if(!side){ showToast('Choose who is playing first.', 3000); return; }
    startAfterDelay(1000);
  });

  els.pause.addEventListener('click', ()=> stopTick());

  els.resetClock.addEventListener('click', ()=>{ stopTick(); timeLeft=30; updateUI(); });

  function handleExtension(sideBtn){
    if(timeLeft<=0 || gameOver || extensionLocked) return;
    const side = activeSide();
    if(!side || (side==='p1' && sideBtn!=='p1') || (side==='p2' && sideBtn!=='p2')) return; // only active side
    extensionLocked=true;
    stopTick(); timeLeft=30; updateUI();
    startAfterDelay(1000);
  }
  els.p1Ext.addEventListener('click', ()=>handleExtension('p1'));
  els.p2Ext.addEventListener('click', ()=>handleExtension('p2'));

  els.p1Plus.addEventListener('click', ()=>score('p1'));
  els.p2Plus.addEventListener('click', ()=>score('p2'));

  els.editP1.addEventListener('click', ()=>setName('p1'));
  els.editP2.addEventListener('click', ()=>setName('p2'));
  els.editRace.addEventListener('click', setRace);

  els.resetScore.addEventListener('click', ()=>{
    p1.score=0; p2.score=0; gameOver=false; extensionLocked=false; resetColors(); updateUI();
  });

  updateUI();
})();
</script>
</body>
</html>
